<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã€ã¦ã‚‰ãã‚“ã€‘è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }
    /* Simple spinner for loading */
    #loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      gap: 1rem;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #4f46e5;
      animation: spin 1s ease infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  
  <!-- Step 1: Load Babel Standalone to transpile TSX in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Step 2: Define paths for modules -->
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "recharts": "https://esm.sh/recharts@2.12.3?external=react,react-dom",
      "html2canvas": "https://esm.sh/html2canvas@1.4.1"
    }
  }
  </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root">
    <!-- Basic loading indicator, will be replaced by React -->
    <div id="loading">
      <div class="spinner"></div>
      <p>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>
  
  <!-- Step 3: Load and transpile the ENTIRE application script INLINE for stability -->
  <script type="text/babel" data-type="module">
    import React from 'react';
    import ReactDOM from 'react-dom/client';
    import { ResponsiveContainer, LineChart, CartesianGrid, XAxis, YAxis, Tooltip as RechartsTooltip, Legend, Line } from 'recharts';
    import html2canvas from 'html2canvas';

    // ====================================================================================
    //  All components and logic are now embedded here to avoid external file issues.
    // ====================================================================================

    // --- from components/InfoIcon.tsx ---
    const InfoIcon = ({ className }) => {
      return (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          className={`h-4 w-4 inline-block ${className}`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
    };

    // --- from components/Tooltip.tsx ---
    const Tooltip = ({ text, children }) => {
      return (
        <div className="relative flex items-center group">
          {children}
          <div className="absolute bottom-full mb-2 w-max max-w-xs p-2 text-sm text-white bg-slate-700 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
            {text}
          </div>
        </div>
      );
    };

    // --- from hooks/useSimulation.ts ---
    const useSimulation = (inputs) => {
        const { useMemo } = React;
        
        const MAX_YEARS = 100;

        const runForwardSimulation = (
            currentAge,
            currentAssets,
            monthlyInvestment,
            annualYield,
            targetAssets,
            lifeEvents,
            initialMonthlyIncome
        ) => {
            if (currentAge <= 0 || targetAssets <= 0 || currentAssets >= targetAssets) {
                return { results: null, chartData: [] };
            }

            const targetAmount = targetAssets * 10000;

            const sortedLifeEvents = [...lifeEvents]
                .filter(event => (Number(event.age) || 0) > 0)
                .sort((a, b) => (Number(a.age) || 0) - (Number(b.age) || 0));
            
            const lifeEventsMap = new Map();
            sortedLifeEvents.forEach(event => {
              const age = Number(event.age) || 0;
              if (age >= currentAge) {
                lifeEventsMap.set(age, event);
              }
            });
            
            const originalEventAges = new Set(sortedLifeEvents.map(e => Number(e.age)));

            const monthlyRate = annualYield / 100 / 12;
            let newAssets = currentAssets * 10000;
            let principal = currentAssets * 10000;
            
            let currentMonthlyInvestment = monthlyInvestment;
            let currentMonthlyIncome = initialMonthlyIncome;

            const data = [{
              age: currentAge,
              totalAssets: Math.round(newAssets / 10000),
              principal: Math.round(principal / 10000),
              isEvent: originalEventAges.has(currentAge),
            }];

            let months = 0;
            let lastAge = currentAge;

            while (newAssets < targetAmount) {
              months++;
              const currentAgeInYears = Math.floor(currentAge + (months - 1) / 12);
              if (currentAgeInYears > lastAge) {
                 data.push({
                    age: currentAgeInYears,
                    totalAssets: Math.round(newAssets / 10000),
                    principal: Math.round(principal / 10000),
                    isEvent: originalEventAges.has(currentAgeInYears),
                });
                lastAge = currentAgeInYears;
              }
              
              if (lifeEventsMap.has(currentAgeInYears)) {
                  const event = lifeEventsMap.get(currentAgeInYears);
                  if (event) {
                      const newIncome = Number(event.newMonthlyIncome);
                      if (newIncome > 0) {
                          currentMonthlyIncome = newIncome;
                      }
                      if (event.goalType === 'rate') {
                          const newRate = Number(event.goalValue);
                          if (newRate >= 0) {
                              currentMonthlyInvestment = (currentMonthlyIncome * newRate) / 100;
                          }
                      } else {
                          const newAmount = Number(event.goalValue);
                          if (newAmount >= 0) {
                              currentMonthlyInvestment = newAmount;
                          }
                      }
                      lifeEventsMap.delete(currentAgeInYears);
                  }
              }

              const monthlyInvestAmount = currentMonthlyInvestment * 10000;
              const interest = newAssets * monthlyRate;
              newAssets += interest;
              if (monthlyInvestAmount > 0) {
                newAssets += monthlyInvestAmount;
                principal += monthlyInvestAmount;
              }
              if (months >= MAX_YEARS * 12) break;
            }
            
            const finalAge = currentAge + months / 12;
            data.push({
                age: Math.round(finalAge * 100) / 100,
                totalAssets: Math.round(newAssets / 10000),
                principal: Math.round(principal / 10000),
                isEvent: originalEventAges.has(Math.floor(finalAge)),
            });

            if (newAssets < targetAmount) {
              return { results: { isAchievable: false }, chartData: data.slice(0, 1) };
            }

            const yearsToGoal = Math.floor(months / 12);
            const monthsToGoal = months % 12;
            const goalAgeExact = currentAge * 12 + months;
            const goalAge = Math.floor(goalAgeExact / 12);
            const goalAgeMonthsPart = goalAgeExact % 12;

            const results = {
              isAchievable: true, goalAge, goalAgeMonthsPart, yearsToGoal, monthsToGoal,
              finalTotalAssets: Math.round(newAssets / 10000),
              totalPrincipal: Math.round(principal / 10000),
              totalInterest: Math.round((newAssets - principal) / 10000),
            };

            return { results, chartData: data };
        }

      return useMemo(() => {
        const currentAge = Number(inputs.currentAge) || 0;
        const currentAssets = Number(inputs.currentAssets) || 0;
        const annualYield = Number(inputs.annualYield) || 0;
        const afterTaxMonthlyIncome = Number(inputs.afterTaxMonthlyIncome) || 0;
        
        let effectiveTargetAssets = 0;
        if (inputs.simulationMode === 'reverse' && inputs.goalSettingMode === 'fire') {
            const livingCost = Number(inputs.fireMonthlyLivingCost) || 0;
            const sideIncome = Number(inputs.fireMonthlySideIncome) || 0;
            const withdrawalRate = Number(inputs.fireWithdrawalRate) || 0;
            if (withdrawalRate > 0) {
                const requiredAnnualSpending = (livingCost - sideIncome) * 12;
                if (requiredAnnualSpending > 0) {
                    effectiveTargetAssets = requiredAnnualSpending / (withdrawalRate / 100);
                }
            }
        } else {
            effectiveTargetAssets = Number(inputs.targetAssets) || 0;
        }

        if (inputs.simulationMode === 'reverse') {
            const targetGoalAge = Number(inputs.targetGoalAge) || 0;
            if (!targetGoalAge || targetGoalAge <= currentAge || !afterTaxMonthlyIncome || effectiveTargetAssets <= 0) {
                 return { results: null, chartData: [], reverseResults: null };
            }
            let low = 0, high = effectiveTargetAssets, requiredMonthlyInvestment = -1;
            for (let i = 0; i < 50; i++) {
                const mid = (low + high) / 2;
                if (mid < 0.01) break;
                const sim = runForwardSimulation(currentAge, currentAssets, mid, annualYield, effectiveTargetAssets, [], afterTaxMonthlyIncome);
                if (sim.results?.isAchievable && sim.results.goalAge <= targetGoalAge) {
                    requiredMonthlyInvestment = mid;
                    high = mid;
                } else {
                    low = mid;
                }
            }
            if (requiredMonthlyInvestment === -1) {
                 return { results: null, chartData: [], reverseResults: { feedbackMessage: 'ã“ã®ç›®æ¨™ã¯ç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç›®æ¨™å¹´é½¢ã‚’å»¶ã°ã™ã‹ã€ç›®æ¨™é¡ãƒ»FIREãƒ—ãƒ©ãƒ³ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚', isAchievable: false } };
            }
            const finalSim = runForwardSimulation(currentAge, currentAssets, requiredMonthlyInvestment, annualYield, effectiveTargetAssets, [], afterTaxMonthlyIncome);
            const requiredSavingsRate = (requiredMonthlyInvestment / afterTaxMonthlyIncome) * 100;
            let feedbackMessage = '';
            if (requiredSavingsRate <= 0) feedbackMessage = 'ç¾åœ¨ã®è³‡ç”£ã ã‘ã§ç›®æ¨™é”æˆå¯èƒ½ã§ã™ï¼';
            else if (requiredSavingsRate <= 25) feedbackMessage = 'ç´ æ™´ã‚‰ã—ã„ï¼ç¾å®Ÿçš„ãªç›®æ¨™ã§ã™ã€‚ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
            else if (requiredSavingsRate <= 40) feedbackMessage = 'è‰¯ã„ç›®æ¨™ã§ã™ï¼å°‘ã—æ„è­˜ã™ã‚Œã°é”æˆå¯èƒ½ã§ã—ã‚‡ã†ã€‚';
            else if (requiredSavingsRate <= 60) feedbackMessage = 'æŒ‘æˆ¦çš„ãªç›®æ¨™ã§ã™ï¼å®¶è¨ˆã®è¦‹ç›´ã—ã‚„åå…¥ã‚¢ãƒƒãƒ—ã‚‚è¦–é‡ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚';
            else if (requiredSavingsRate <= 100) feedbackMessage = 'ã‹ãªã‚Šé«˜ã„ç›®æ¨™ã§ã™ï¼å‰¯æ¥­ã‚„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®å”åŠ›ã‚‚æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚';
            else feedbackMessage = 'é”æˆå›°é›£ãªç›®æ¨™ã§ã™ã€‚åå…¥ã‚’å¤§å¹…ã«å¢—ã‚„ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
            const reverseResults = {
                requiredMonthlyInvestment: Math.round(requiredMonthlyInvestment * 10) / 10,
                requiredSavingsRate: Math.round(requiredSavingsRate * 10) / 10,
                feedbackMessage,
                isAchievable: true,
            };
            return { ...finalSim, reverseResults };
        }

        const initialMonthlyIncome = Number(inputs.afterTaxMonthlyIncome) || 0;
        let effectiveMonthlyInvestment = 0;
        if (inputs.simulationMode === 'savingsRate') {
            const rate = Number(inputs.targetSavingsRate) || 0;
            effectiveMonthlyInvestment = (initialMonthlyIncome * rate) / 100;
        } else {
            effectiveMonthlyInvestment = Number(inputs.monthlyInvestment) || 0;
        }

        const forwardSim = runForwardSimulation(currentAge, currentAssets, effectiveMonthlyInvestment, annualYield, effectiveTargetAssets, inputs.lifeEvents, initialMonthlyIncome);
        return { ...forwardSim, reverseResults: null };
      }, [inputs]);
    };

    // --- from components/InputForm.tsx ---
    const InputField = ({ label, name, value, onChange, unit, tooltip, min = 0, max, step = 0.01 }) => (
      <div>
        <label htmlFor={name} className="block text-sm font-medium text-slate-600 mb-1">
          {label}
          {tooltip && (
            <Tooltip text={tooltip}>
              <InfoIcon className="ml-1 text-slate-400" />
            </Tooltip>
          )}
        </label>
        <div className="relative">
          <input
            type="number" id={name} name={name} value={value} onChange={onChange}
            min={min} max={max} step={step} placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„"
            className={`w-full pl-3 pr-12 py-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-white text-slate-900 ${value === '' ? 'placeholder:text-red-400' : ''}`}
          />
          <span className="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-500">{unit}</span>
        </div>
      </div>
    );
    const LifeEventCard = ({ event, onChange, onDelete, beforeIncome, beforeInvestment, beforeRate }) => {
        const { useMemo } = React;
        const calculatedRate = useMemo(() => {
            const income = Number(event.newMonthlyIncome) || beforeIncome;
            if (event.goalType === 'amount' && income > 0) return ((Number(event.goalValue) || 0) / income) * 100;
            return null;
        }, [event.goalType, event.goalValue, event.newMonthlyIncome, beforeIncome]);
        const calculatedAmount = useMemo(() => {
            const income = Number(event.newMonthlyIncome) || beforeIncome;
            if (event.goalType === 'rate') return (income * (Number(event.goalValue) || 0)) / 100;
            return null;
        }, [event.goalType, event.goalValue, event.newMonthlyIncome, beforeIncome]);
        return (
            <details className="bg-slate-100 p-3 rounded-lg animate-fade-in group border border-slate-200" open>
                <summary className="flex justify-between items-center font-semibold text-slate-700 cursor-pointer">
                    <div className="flex items-center">
                        <input type="number" name="age" value={event.age} onChange={(e) => onChange(event.id, 'age', e.target.value)} className="w-16 p-1 border border-slate-300 rounded-md text-sm text-center bg-white text-slate-900 font-bold" onClick={(e) => e.stopPropagation()} />
                        <span className="ml-2">æ­³ã‹ã‚‰ã®ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</span>
                    </div>
                    <button onClick={(e) => { e.preventDefault(); onDelete(event.id); }} className="text-red-500 hover:text-red-700 font-bold p-1 rounded-full">&times;</button>
                </summary>
                <div className="mt-4 space-y-4 border-t pt-4">
                    <div>
                        <label className="text-sm font-medium text-slate-600">æ‰‹å–ã‚Šæœˆå</label>
                        <div className="flex items-center flex-wrap space-x-2 text-sm mt-1">
                            <span className="text-slate-500">å¤‰æ›´å‰: {beforeIncome.toLocaleString()} ä¸‡å††</span>
                            <span>â†’</span>
                            <div className="relative">
                                <input type="number" name="newMonthlyIncome" value={event.newMonthlyIncome} onChange={(e) => onChange(event.id, 'newMonthlyIncome', e.target.value)} className="w-24 py-1 pl-3 pr-10 border border-slate-300 rounded-md text-sm bg-white text-slate-900" placeholder="å…¥åŠ›" min={0} step="0.01" />
                                 <span className="absolute inset-y-0 right-0 flex items-center pr-2 text-slate-500">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label className="text-sm font-medium text-slate-600">ç©ç«‹ç›®æ¨™</label>
                        <div className="flex items-center space-x-4 mt-1">
                             <label className="flex items-center cursor-pointer">
                                <input type="radio" name={`goalType-${event.id}`} value="amount" checked={event.goalType === 'amount'} onChange={() => onChange(event.id, 'goalType', 'amount')} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300" />
                                <span className="ml-2 text-xs text-slate-700">ç©ç«‹é¡ã§æŒ‡å®š</span>
                            </label>
                             <label className="flex items-center cursor-pointer">
                                <input type="radio" name={`goalType-${event.id}`} value="rate" checked={event.goalType === 'rate'} onChange={() => onChange(event.id, 'goalType', 'rate')} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300" />
                                <span className="ml-2 text-xs text-slate-700">è²¯è“„ç‡ã§æŒ‡å®š</span>
                            </label>
                        </div>
                    </div>
                    {event.goalType === 'amount' ? (
                        <div>
                            <div className="flex items-center flex-wrap space-x-2 text-sm">
                                <span className="text-slate-500">å¤‰æ›´å‰: {beforeInvestment.toLocaleString()} ä¸‡å††</span>
                                <span>â†’</span>
                                 <div className="relative">
                                    <input type="number" name="goalValue" value={event.goalValue} onChange={(e) => onChange(event.id, 'goalValue', e.target.value)} className="w-24 py-1 pl-3 pr-10 border border-slate-300 rounded-md text-sm bg-white text-slate-900" placeholder="å…¥åŠ›" min={0} step="0.01" />
                                    <span className="absolute inset-y-0 right-0 flex items-center pr-2 text-slate-500">ä¸‡å††</span>
                                 </div>
                            </div>
                            {calculatedRate !== null && <p className="text-xs text-slate-500 mt-1">(è‡ªå‹•è¨ˆç®—ã•ã‚ŒãŸè²¯è“„ç‡: {calculatedRate.toFixed(2)} %)</p>}
                        </div>
                    ) : (
                        <div>
                            <div className="flex items-center flex-wrap space-x-2 text-sm">
                                 <span className="text-slate-500">å¤‰æ›´å‰: {beforeRate.toFixed(2)} %</span>
                                 <span>â†’</span>
                                  <div className="relative">
                                    <input type="number" name="goalValue" value={event.goalValue} onChange={(e) => onChange(event.id, 'goalValue', e.target.value)} className="w-24 py-1 pl-3 pr-8 border border-slate-300 rounded-md text-sm bg-white text-slate-900" placeholder="å…¥åŠ›" min={0} step="0.01" />
                                    <span className="absolute inset-y-0 right-0 flex items-center pr-2 text-slate-500">%</span>
                                  </div>
                            </div>
                            {calculatedAmount !== null && <p className="text-xs text-slate-500 mt-1">(è‡ªå‹•è¨ˆç®—ã•ã‚ŒãŸç©ç«‹é¡: {calculatedAmount.toFixed(2)} ä¸‡å††)</p>}
                        </div>
                    )}
                </div>
            </details>
        );
    };
    const ModeSwitcher = ({ mode, onModeChange }) => {
        const modes = [
            { key: 'contribution', label: 'â‘  ç©ç«‹é¡ã‹ã‚‰è¨ˆç®—' },
            { key: 'savingsRate', label: 'â‘¡ è²¯è“„ç‡ã‹ã‚‰è¨ˆç®—' },
            { key: 'reverse', label: 'â‘¢ ç›®æ¨™ã‹ã‚‰é€†ç®—' },
        ];
        return (
            <div>
                <label className="block text-sm font-medium text-slate-600 mb-2">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</label>
                <div className="flex bg-slate-200 rounded-lg p-1 space-x-1">
                    {modes.map(m => (
                        <button key={m.key} onClick={() => onModeChange(m.key)} className={`w-1/3 py-2 px-1 text-xs md:text-sm font-semibold rounded-md transition-all duration-300 ${mode === m.key ? 'bg-white text-indigo-600 shadow' : 'bg-transparent text-slate-600 hover:bg-slate-300'}`}>
                            {m.label}
                        </button>
                    ))}
                </div>
            </div>
        );
    };
    const GoalSettingSwitcher = ({ mode, onModeChange }) => (
        <div className="flex items-center justify-center space-x-4">
            <label className="flex items-center cursor-pointer">
                <input type="radio" name="goal-setting" value="amount" checked={mode === 'amount'} onChange={() => onModeChange('amount')} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300" />
                <span className="ml-2 text-sm text-slate-700">é‡‘é¡ã§æŒ‡å®š</span>
            </label>
             <label className="flex items-center cursor-pointer">
                <input type="radio" name="goal-setting" value="fire" checked={mode === 'fire'} onChange={() => onModeChange('fire')} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300" />
                <span className="ml-2 text-sm text-slate-700">FIREãƒ—ãƒ©ãƒ³ã§æŒ‡å®š</span>
            </label>
        </div>
    );
    const InputForm = ({ inputs, onInputChange, onReset, onAddEvent, onDeleteEvent, onEventChange, onModeChange, onGoalSettingModeChange }) => {
      const { useMemo } = React;
      const calculatedInvestment = useMemo(() => {
        if (inputs.simulationMode !== 'savingsRate') return 0;
        const income = Number(inputs.afterTaxMonthlyIncome) || 0;
        const rate = Number(inputs.targetSavingsRate) || 0;
        return Math.round(((income * rate) / 100) * 100) / 100;
      }, [inputs.simulationMode, inputs.afterTaxMonthlyIncome, inputs.targetSavingsRate]);
      const calculatedFireTargetAssets = useMemo(() => {
        if (inputs.simulationMode !== 'reverse' || inputs.goalSettingMode !== 'fire') return 0;
        const livingCost = Number(inputs.fireMonthlyLivingCost) || 0;
        const sideIncome = Number(inputs.fireMonthlySideIncome) || 0;
        const withdrawalRate = Number(inputs.fireWithdrawalRate) || 0;
        if (withdrawalRate <= 0) return 0;
        const requiredAnnualSpending = (livingCost - sideIncome) * 12;
        if (requiredAnnualSpending <= 0) return 0;
        const target = requiredAnnualSpending / (withdrawalRate / 100);
        return Math.round(target);
      }, [inputs.simulationMode, inputs.goalSettingMode, inputs.fireMonthlyLivingCost, inputs.fireMonthlySideIncome, inputs.fireWithdrawalRate]);
      const eventPrecursors = useMemo(() => {
            const precursors = new Map();
            const sortedEvents = [...inputs.lifeEvents].sort((a, b) => (Number(a.age) || Infinity) - (Number(b.age) || Infinity));
            let currentIncome = Number(inputs.afterTaxMonthlyIncome) || 0;
            let currentInvestment = 0;
            if (inputs.simulationMode === 'contribution') {
                currentInvestment = Number(inputs.monthlyInvestment) || 0;
            } else if (inputs.simulationMode === 'savingsRate') {
                const rate = Number(inputs.targetSavingsRate) || 0;
                currentInvestment = (currentIncome * rate) / 100;
            }
            for (const event of sortedEvents) {
                const currentRate = currentIncome > 0 ? (currentInvestment / currentIncome) * 100 : 0;
                precursors.set(event.id, { income: currentIncome, investment: currentInvestment, rate: currentRate });
                const eventIncome = Number(event.newMonthlyIncome);
                if (eventIncome > 0) currentIncome = eventIncome;
                if (event.goalType === 'rate') currentInvestment = (currentIncome * (Number(event.goalValue) || 0)) / 100;
                else currentInvestment = Number(event.goalValue) || 0;
            }
            return precursors;
        }, [inputs.lifeEvents, inputs.afterTaxMonthlyIncome, inputs.monthlyInvestment, inputs.targetSavingsRate, inputs.simulationMode]);
      const isReverseMode = inputs.simulationMode === 'reverse';
      return (
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h2 className="text-xl font-bold text-slate-800 mb-6 border-b pb-3">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶</h2>
          <div className="space-y-5">
            <ModeSwitcher mode={inputs.simulationMode} onModeChange={onModeChange} />
            <div className="space-y-5 pt-4 border-t">
              <InputField label="ç¾åœ¨ã®å¹´é½¢" name="currentAge" value={inputs.currentAge} onChange={onInputChange} unit="æ­³" step={1} />
              <InputField label="ç¾åœ¨ã®è³‡ç”£" name="currentAssets" value={inputs.currentAssets} onChange={onInputChange} unit="ä¸‡å††" />
              <InputField label="æƒ³å®šåˆ©å›ã‚Š" name="annualYield" value={inputs.annualYield} onChange={onInputChange} unit="%" tooltip="1å¹´é–“ã®æŠ•è³‡ã§å¾—ã‚‰ã‚Œã‚‹åˆ©ç›Šã®å‰²åˆã§ã™ã€‚S&P500ã®å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ã¯å¹´5~7%ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚" />
              {inputs.simulationMode === 'contribution' && (<>
                  <div>
                     <InputField label="æ¯æœˆã®ç©ç«‹é¡" name="monthlyInvestment" value={inputs.monthlyInvestment} onChange={onInputChange} unit="ä¸‡å††" max={100} />
                      <input type="range" name="monthlyInvestment" value={inputs.monthlyInvestment} onChange={onInputChange} min="0" max="100" step="0.1" className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer mt-2 accent-indigo-600" />
                  </div>
                  <InputField label="ç›®æ¨™è³‡ç”£é¡" name="targetAssets" value={inputs.targetAssets} onChange={onInputChange} unit="ä¸‡å††" />
                </>)}
              {inputs.simulationMode === 'savingsRate' && (<>
                  <div className="space-y-5 p-4 bg-slate-50 rounded-lg">
                      <InputField label="æ‰‹å–ã‚Šæœˆå" name="afterTaxMonthlyIncome" value={inputs.afterTaxMonthlyIncome} onChange={onInputChange} unit="ä¸‡å††" />
                      <InputField label="ç›®æ¨™è²¯è“„ç‡" name="targetSavingsRate" value={inputs.targetSavingsRate} onChange={onInputChange} unit="%" max={100} />
                      <div className="text-center border-t pt-3">
                          <p className="text-sm text-slate-600">æ¯æœˆã®ç©ç«‹é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</p>
                          <p className="text-2xl font-bold text-indigo-600">{calculatedInvestment.toLocaleString()} ä¸‡å††</p>
                      </div>
                  </div>
                  <InputField label="ç›®æ¨™è³‡ç”£é¡" name="targetAssets" value={inputs.targetAssets} onChange={onInputChange} unit="ä¸‡å††" />
                </>)}
              {inputs.simulationMode === 'reverse' && (<div className="space-y-5">
                    <InputField label="æ‰‹å–ã‚Šæœˆå" name="afterTaxMonthlyIncome" value={inputs.afterTaxMonthlyIncome} onChange={onInputChange} unit="ä¸‡å††" />
                    <InputField label="ç›®æ¨™é”æˆå¹´é½¢" name="targetGoalAge" value={inputs.targetGoalAge} onChange={onInputChange} unit="æ­³" step={1} />
                    <div className="border-t pt-4 space-y-4">
                      <label className="block text-sm font-medium text-slate-600 text-center">â–¼ ã©ã‚“ãªã‚´ãƒ¼ãƒ«ã‚’ç›®æŒ‡ã—ã¾ã™ã‹ï¼Ÿ</label>
                      <GoalSettingSwitcher mode={inputs.goalSettingMode} onModeChange={onGoalSettingModeChange} />
                      {inputs.goalSettingMode === 'amount' && (<InputField label="ç›®æ¨™è³‡ç”£é¡" name="targetAssets" value={inputs.targetAssets} onChange={onInputChange} unit="ä¸‡å††" />)}
                      {inputs.goalSettingMode === 'fire' && (<div className="space-y-5 p-4 bg-slate-50 rounded-lg animate-fade-in">
                            <InputField label="ãƒªã‚¿ã‚¤ã‚¢å¾Œã®æœˆé–“ç”Ÿæ´»è²»" name="fireMonthlyLivingCost" value={inputs.fireMonthlyLivingCost} onChange={onInputChange} unit="ä¸‡å††" tooltip="FIREå¾Œã«æ¯æœˆå¿…è¦ã«ãªã‚‹ã§ã‚ã‚ã†ç”Ÿæ´»è²»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" />
                            <InputField label="ãƒªã‚¿ã‚¤ã‚¢å¾Œã®æœˆé–“åŠ´åƒåå…¥" name="fireMonthlySideIncome" value={inputs.fireMonthlySideIncome} onChange={onInputChange} unit="ä¸‡å††" tooltip="ã‚µã‚¤ãƒ‰FIREãªã©ã§è¦‹è¾¼ã‚€ã€ãƒªã‚¿ã‚¤ã‚¢å¾Œã®åŠ´åƒåå…¥ã§ã™ã€‚ãªã‘ã‚Œã°0ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" />
                            <InputField label="è³‡ç”£ã®å–ã‚Šå´©ã—ç‡" name="fireWithdrawalRate" value={inputs.fireWithdrawalRate} onChange={onInputChange} unit="%" tooltip="è³‡ç”£ã‚’æ¯å¹´ä½•%ãšã¤ä½¿ã£ã¦ã„ãã‹ã€‚ä¸€èˆ¬çš„ã«4%ãŒç›®å®‰ã¨ã•ã‚Œã¾ã™ã€‚" />
                            <div className="text-center border-t pt-3">
                                <p className="text-sm text-slate-600">ãã®ãŸã‚ã«å¿…è¦ãªç›®æ¨™è³‡ç”£é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</p>
                                <p className="text-2xl font-bold text-indigo-600">{calculatedFireTargetAssets.toLocaleString()} ä¸‡å††</p>
                            </div>
                          </div>)}
                    </div>
                </div>)}
            </div>
          </div>
          <div className={`mt-8 transition-opacity duration-300 ${isReverseMode ? 'opacity-50 pointer-events-none' : ''}`}>
            <h3 className="text-lg font-bold text-slate-700 mb-4 border-b pb-2">ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
            {isReverseMode && (<div className="text-xs text-amber-700 bg-amber-100 p-2 rounded-md mb-3">(æ³¨)é€†ç®—ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆã¯è¨­å®šã§ãã¾ã›ã‚“</div>)}
            <div className="space-y-3 mb-4">{inputs.lifeEvents.map(event => {
                    const precursor = eventPrecursors.get(event.id) || { income: 0, investment: 0, rate: 0 };
                    return (<LifeEventCard key={event.id} event={event} onChange={onEventChange} onDelete={onDeleteEvent} beforeIncome={precursor.income} beforeInvestment={precursor.investment} beforeRate={precursor.rate} />);
              })}</div>
            <button onClick={onAddEvent} className="w-full py-2 px-4 bg-sky-500 text-white font-semibold rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-150 disabled:bg-sky-300 disabled:cursor-not-allowed" disabled={isReverseMode}>+ ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>
          </div>
          <div className="pt-8"><button onClick={onReset} className="w-full py-2 px-4 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition duration-150">å…¥åŠ›å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
        </div>
      );
    };

    // --- from components/ResultsDisplay.tsx ---
    const ResultCard = ({ title, children, className }) => (
        <div className={`bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center ${className}`}>
            <h3 className="text-sm font-semibold text-slate-500 mb-1">{title}</h3>
            <div className="text-2xl lg:text-3xl font-bold text-slate-800">{children}</div>
        </div>
    );
    const ReverseResultCard = ({ reverseResults }) => {
        const rateColor = reverseResults.requiredSavingsRate > 50 ? 'text-red-500' : reverseResults.requiredSavingsRate > 35 ? 'text-amber-500' : 'text-emerald-500';
        if (!reverseResults.isAchievable) {
            return (<div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-xl shadow-md sm:col-span-2"><p className="font-bold">ç›®æ¨™é”æˆã¯å›°é›£ã§ã™</p><p>{reverseResults.feedbackMessage}</p></div>)
        }
        return (
            <div className="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-xl shadow-md sm:col-span-2">
                <h3 className="font-bold text-lg mb-2">ç›®æ¨™é”æˆã®ãŸã‚ã®è©¦ç®—çµæœ</h3>
                <p>ã‚ãªãŸã®ç›®æ¨™ã‚’é”æˆã™ã‚‹ã«ã¯ã€æ¯æœˆ <strong className={`text-2xl font-bold ${rateColor}`}>{reverseResults.requiredMonthlyInvestment.toLocaleString()} ä¸‡å††</strong> ã®ç©ç«‹ãŒå¿…è¦ã§ã™ã€‚</p>
                <p className="mt-1">ã“ã‚Œã¯æ‰‹å–ã‚Šæœˆåã«å¯¾ã—ã€<strong className={`text-2xl font-bold ${rateColor}`}>{reverseResults.requiredSavingsRate}%</strong> ã®è²¯è“„ç‡ã«ç›¸å½“ã—ã¾ã™ã€‚</p>
                <p className="mt-3 text-sm bg-indigo-100 p-2 rounded-md">{reverseResults.feedbackMessage}</p>
            </div>
        );
    };
    const ResultsDisplay = ({ results, reverseResults, mode }) => {
      const formatYen = (amount) => new Intl.NumberFormat('ja-JP').format(amount) + 'ä¸‡å††';
      if (!results && !reverseResults?.isAchievable) return (<div className="flex items-center justify-center min-h-[10rem] bg-slate-100 p-6 rounded-2xl shadow-inner text-slate-500">æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>);
      if (results && !results.isAchievable) return (<div className="flex items-center justify-center min-h-[10rem] bg-amber-50 p-6 rounded-2xl shadow-inner text-amber-700">ç¾åœ¨ã®è¨­å®šã§ã¯100å¹´ä»¥å†…ã«ç›®æ¨™ã‚’é”æˆã§ãã¾ã›ã‚“ã€‚ç©ç«‹é¡ã‚’å¢—ã‚„ã™ã‹ã€ç›®æ¨™ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</div>);
      if (!results) {
           return (<div className="bg-slate-100 p-6 rounded-2xl shadow-inner space-y-4">
                  <h2 className="text-xl font-bold text-slate-800 mb-2 border-b pb-3">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h2>
                   {mode === 'reverse' && reverseResults && <ReverseResultCard reverseResults={reverseResults} />}
                   <div className="flex items-center justify-center min-h-[10rem] bg-slate-100 p-6 rounded-2xl text-slate-500">{reverseResults?.isAchievable ? 'ç›®æ¨™é”æˆæ™‚ã®è©³ç´°ã‚’è¨ˆç®—ä¸­ã§ã™...' : 'æœ‰åŠ¹ãªæ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'}</div>
              </div>)
      }
      return (
        <div className="bg-slate-100 p-6 rounded-2xl shadow-inner">
          <h2 className="text-xl font-bold text-slate-800 mb-6 border-b pb-3">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {mode === 'reverse' && reverseResults && <ReverseResultCard reverseResults={reverseResults} />}
              <div className="bg-indigo-600 text-white p-4 rounded-xl shadow-lg flex flex-col items-center justify-center text-center sm:col-span-2">
                <h3 className="text-base font-semibold text-indigo-200 mb-1">ç›®æ¨™é”æˆå¹´é½¢</h3>
                <p className="text-4xl lg:text-5xl font-extrabold">{results.goalAge}æ­³ <span className="text-2xl lg:text-3xl font-semibold">{results.goalAgeMonthsPart}ãƒ¶æœˆ</span></p>
              </div>
              <ResultCard title="é”æˆã¾ã§ã‚ã¨">{results.yearsToGoal}å¹´ {results.monthsToGoal}ãƒ¶æœˆ</ResultCard>
              <ResultCard title="æœ€çµ‚è³‡ç”£é¡">{formatYen(results.finalTotalAssets)}</ResultCard>
               <div className="bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center sm:col-span-2">
                    <div className="w-full">
                        <div className="flex justify-between text-sm text-slate-600 mb-1"><span>ç©ç«‹å…ƒæœ¬</span><span>é‹ç”¨åˆ©ç›Š</span></div>
                        <div className="w-full bg-slate-200 rounded-full h-4 overflow-hidden flex">
                            <div className="bg-sky-500" style={{ width: `${(results.totalPrincipal / results.finalTotalAssets) * 100}%` }}></div>
                            <div className="bg-emerald-500" style={{ width: `${(results.totalInterest / results.finalTotalAssets) * 100}%` }}></div>
                        </div>
                         <div className="flex justify-between text-sm font-bold mt-1">
                            <span className="text-sky-600">{formatYen(results.totalPrincipal)}</span>
                            <span className="text-emerald-600">{formatYen(results.totalInterest)}</span>
                        </div>
                    </div>
               </div>
          </div>
        </div>
      );
    };

    // --- from components/AssetChart.tsx ---
    const EventMarker = (props) => {
      const { cx, cy, payload } = props;
      if (payload.isEvent) return (<svg x={cx - 10} y={cy - 10} width="20" height="20" fill="#f59e0b" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>);
      return null;
    };
    const AssetChart = ({ data }) => {
      if (!data || data.length <= 1) return (<div id="asset-chart-container" className="flex items-center justify-center h-[400px] bg-white p-6 rounded-2xl shadow-lg text-slate-500">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€æœ‰åŠ¹ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœãŒå¿…è¦ã§ã™ã€‚</div>);
      const formatYen = (value) => `${value.toLocaleString()} ä¸‡å††`;
      const formatAge = (value) => `${Math.floor(value)}æ­³`;
      const maxAssets = data.length > 0 ? Math.max(...data.map(d => d.totalAssets), 0) : 0;
      let yAxisTicks = [0], topDomain = 1000;
      if (maxAssets > 0) {
        const interval = Math.ceil((maxAssets / 5) / 1000) * 1000;
        const safeInterval = Math.max(interval, 1000); 
        topDomain = Math.ceil(maxAssets / safeInterval) * safeInterval;
        yAxisTicks = [];
        for (let i = 0; i <= topDomain; i += safeInterval) yAxisTicks.push(i);
      }
      return (
        <div id="asset-chart-container" className="bg-white p-4 md:p-6 rounded-2xl shadow-lg h-[400px]">
          <h3 className="text-xl font-bold text-slate-800 mb-4">è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
          <ResponsiveContainer width="100%" height="90%">
            <LineChart data={data} margin={{ top: 5, right: 20, left: 20, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
              <XAxis dataKey="age" tickFormatter={formatAge} tick={{ fill: '#64748b' }} minTickGap={20} />
              <YAxis tickFormatter={formatYen} tick={{ fill: '#64748b' }} width={80} domain={[0, topDomain]} ticks={yAxisTicks} allowDataOverflow={true} />
              <RechartsTooltip formatter={(value, name) => [formatYen(value), name === 'totalAssets' ? 'è³‡ç”£ç·é¡' : 'ç©ç«‹å…ƒæœ¬']} labelFormatter={(label) => formatAge(label)} contentStyle={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', backdropFilter: 'blur(4px)', border: '1px solid #e2e8f0', borderRadius: '0.75rem' }} />
              <Legend verticalAlign="top" height={36} />
              <Line type="monotone" dataKey="principal" stroke="#0ea5e9" strokeWidth={2} dot={false} name="ç©ç«‹å…ƒæœ¬" />
              <Line type="monotone" dataKey="totalAssets" stroke="#10b981" strokeWidth={3} dot={<EventMarker />} activeDot={{ r: 6 }} name="è³‡ç”£ç·é¡" />
            </LineChart>
          </ResponsiveContainer>
        </div>
      );
    };

    // --- from components/ShareModule.tsx ---
    const ShareModule = ({ results, chartData }) => {
        const { useState, useCallback } = React;
        const [isGenerating, setIsGenerating] = useState(false);
        const getTimestamp = () => new Date().toISOString().replace(/[-:.]/g, "").replace("T", "_").slice(0,15);
        const handleDownloadImage = useCallback(async () => {
            const chartElement = document.getElementById('asset-chart-container');
            if (chartElement && !isGenerating) {
                setIsGenerating(true);
                try {
                    const canvas = await html2canvas(chartElement, { backgroundColor: '#ffffff', scale: 2 });
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = 'asset-simulation-chart.png';
                    link.click();
                } catch (error) { console.error('Error generating image:', error); alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
                finally { setIsGenerating(false); }
            }
        }, [isGenerating]);
        const handleDownloadCsv = useCallback(() => {
            if (!chartData || chartData.length <= 1) return alert('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            const headers = ['å¹´é½¢(æ­³)', 'å¹´åˆè³‡ç”£é¡(ä¸‡å††)', 'å¹´é–“ç©ç«‹é¡(ä¸‡å††)', 'å¹´é–“é‹ç”¨ç›Š(ä¸‡å††)', 'å¹´æœ«è³‡ç”£é¡(ä¸‡å††)'];
            const rows = chartData.slice(1).map((item, index) => {
                const prevItem = chartData[index];
                const age = Math.floor(prevItem.age);
                const startOfYearAssets = prevItem.totalAssets;
                const endOfYearAssets = item.totalAssets;
                const annualContribution = item.principal - prevItem.principal;
                const annualInterest = endOfYearAssets - startOfYearAssets - annualContribution;
                return [age, startOfYearAssets, annualContribution, annualInterest, endOfYearAssets].join(',');
            });
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `asset_simulation_${getTimestamp()}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        }, [chartData]);

        if (!results || !results.isAchievable) return null;
        return (
            <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
                <button onClick={handleDownloadImage} disabled={isGenerating} className="w-full sm:w-auto flex items-center justify-center py-2 px-6 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition duration-150 disabled:bg-slate-400"><svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>{isGenerating ? 'ç”Ÿæˆä¸­...' : 'ã‚°ãƒ©ãƒ•ã‚’ç”»åƒã§ä¿å­˜'}</button>
                <button onClick={handleDownloadCsv} disabled={!chartData || chartData.length <= 1} className="w-full sm:w-auto flex items-center justify-center py-2 px-6 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition duration-150 disabled:bg-sky-300"><svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        );
    };
    
    // --- from components/HowToDeployFree.tsx ---
    const HowToDeployFree = () => {
        const Code = ({ children }) => <code className="bg-slate-200 text-slate-900 px-1.5 py-1 rounded text-sm font-mono not-prose">{children}</code>;
        const Step = ({ number, title, children }) => (
            <div className="flex items-start"><div className="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full bg-indigo-500 text-white font-bold text-lg mr-4">{number}</div><div><h4 className="font-bold text-slate-900 text-lg">{title}</h4><div className="text-sm md:text-base ml-0 prose prose-sm prose-slate max-w-none">{children}</div></div></div>
        );
        return (
            <div className="bg-slate-50 border-2 border-dashed border-slate-300 text-slate-800 p-6 rounded-2xl mt-8">
                <h3 className="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    ã€ç©¶æ¥µã®æœ€çµ‚ç‰ˆã€‘ãŸã£ãŸ1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œæˆï¼
                </h3>
                <div className="mb-6 text-sm font-semibold bg-emerald-100 text-emerald-800 p-3 rounded-lg leading-relaxed">
                    <strong>ã‚‚ã†å¤§ä¸ˆå¤«ã§ã™ï¼å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ãŒã“ã®1ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆã•ã‚Œã¾ã—ãŸã€‚</strong>
                    <br />
                    å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€éš›ã®å•é¡ŒãŒå…¨ã¦ã®åŸå› ã§ã—ãŸã€‚ã“ã®æ–°ã—ã„æ–¹æ³•ãªã‚‰ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨å…¬é–‹å¾Œã§å‹•ä½œãŒå¤‰ã‚ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ã‚ã‚Šã¾ã›ã‚“ã€‚
                </div>
                <div className="space-y-8">
                    <Step number="1" title="GitHubã§ã€æ–°ã—ã„ä¿ç®¡å ´æ‰€ï¼ˆãƒªãƒã‚¸ãƒˆãƒªï¼‰ã‚’ä½œã‚‹">
                        <p><a href="https://github.com/new" target="_blank" rel="noopener noreferrer" className="text-indigo-600 font-bold hover:underline">GitHub</a> ã§ã€æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚åå‰ã¯è‡ªç”±ã§ã™ã€‚</p>
                    </Step>
                    <Step number="2" title="ã“ã® index.html ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹">
                         <p>ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã®ãƒšãƒ¼ã‚¸ã§ã€Œ<strong>Create a new file</strong>ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
                         <p>ãƒ•ã‚¡ã‚¤ãƒ«åã« <Code>index.html</Code> ã¨å…¥åŠ›ã—ã¾ã™ã€‚</p>
                         <p>ã“ã®ãƒšãƒ¼ã‚¸ã®<strong>å…¨å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</strong>ã—ã¦ã€GitHubã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã€ã€ŒCommit new fileã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
                         <p className="mt-2 text-xs bg-amber-100 text-amber-800 p-3 rounded-lg">
                           <strong className="font-bold">é‡è¦:</strong> ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ã‚‚ã†ã“ã®<Code>index.html</Code>ãƒ•ã‚¡ã‚¤ãƒ«1ã¤ã ã‘ã§å®Œçµã—ã¾ã™ã€‚ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸è¦ã§ã™ã€‚
                        </p>
                    </Step>
                     <Step number="3" title="GitHub Pagesã‚’æœ‰åŠ¹ã«ã—ã¦ã€ä¸–ç•Œã«å…¬é–‹ï¼">
                        <p>ãƒªãƒã‚¸ãƒˆãƒªã®ã€Œ<Code>Settings</Code>ã€â†’ã€Œ<Code>Pages</Code>ã€ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
                        <p>"Branch"ã®é …ç›®ã§ <Code>main</Code> (ã¾ãŸã¯ <Code>master</Code>) ã‚’é¸æŠã—ã€ã€Œ<Code>Save</Code>ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
                    </Step>
                </div>
                 <p className="mt-8 text-lg font-semibold bg-emerald-100 text-emerald-800 p-4 rounded-lg text-center">
                    ğŸ‰ <strong>ã“ã‚Œã ã‘ã§ã€å®Œäº†ã§ã™ï¼</strong><br />
                    <span className="text-sm font-normal">æ•°åˆ†å¾…ã¤ã¨ã€åŒã˜ãƒšãƒ¼ã‚¸ã«å…¬é–‹ç”¨URLãŒè¡¨ç¤ºã•ã‚Œã€ä¸–ç•Œä¸­ã®èª°ã§ã‚‚ã‚ãªãŸã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼</span>
                </p>
            </div>
        );
    }

    // --- from App.tsx ---
    const INITIAL_STATE = {
      simulationMode: 'contribution',
      currentAge: 25, currentAssets: 100, monthlyInvestment: 5,
      afterTaxMonthlyIncome: 25, targetSavingsRate: 20, annualYield: 5,
      targetAssets: 5000, targetGoalAge: 45, lifeEvents: [],
      goalSettingMode: 'amount', fireMonthlyLivingCost: 15,
      fireMonthlySideIncome: 5, fireWithdrawalRate: 4,
    };
    const STORAGE_KEY = 'futureSelfSimulatorProState_v5';
    const Header = () => (<header className="bg-white shadow-md"><div className="container mx-auto px-4 py-4"><h1 className="text-xl md:text-2xl font-bold text-slate-800">ã€ã¦ã‚‰ãã‚“ã€‘è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro</h1></div></header>);
    const Footer = () => (<footer className="bg-slate-800 text-slate-300 py-6 mt-12"><div className="container mx-auto px-4 text-center text-sm"><p>&copy; {new Date().getFullYear()} ã¦ã‚‰ãã‚“</p><p className="mt-2">æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç‰¹å®šã®é‡‘èå•†å“ã‚’æ¨å¥¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</p><a href="https://www.youtube.com/@terazon-2025" target="_blank" rel="noopener noreferrer" className="mt-2 inline-block text-indigo-400 hover:text-indigo-300 transition">YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã¯ã“ã¡ã‚‰</a></div></footer>);

    const App = () => {
      const { useState, useCallback, useEffect } = React;
      const [inputs, setInputs] = useState(() => {
        try {
          const savedState = localStorage.getItem(STORAGE_KEY);
          if (savedState) {
            const parsed = JSON.parse(savedState);
            const finalState = { ...INITIAL_STATE, ...parsed };
            finalState.lifeEvents = Array.isArray(finalState.lifeEvents) ? finalState.lifeEvents : [];
            return finalState;
          }
        } catch (error) { console.error("Failed to parse state", error); }
        return INITIAL_STATE;
      });

      const { results, chartData, reverseResults } = useSimulation(inputs);

      useEffect(() => {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(inputs)); }
        catch (error) { console.error("Failed to save state", error); }
      }, [inputs]);
      
      const handleInputChange = useCallback((e) => {
        const { name, value } = e.target;
        let finalValue = '';
        if (value !== '') {
            const num = parseFloat(value);
            if (!isNaN(num) && Number.isFinite(num)) {
                finalValue = (name === 'currentAge' || name === 'targetGoalAge') ? Math.round(num) : num;
            } else { return; }
        }
        setInputs(prev => {
            const newInputs = { ...prev, [name]: finalValue };
            const income = Number(newInputs.afterTaxMonthlyIncome) || 0;
            if (newInputs.simulationMode === 'savingsRate') {
                if (name === 'afterTaxMonthlyIncome' || name === 'targetSavingsRate') {
                    const rate = Number(newInputs.targetSavingsRate) || 0;
                    newInputs.monthlyInvestment = Math.round(((income * rate) / 100) * 100) / 100;
                }
            } else if (newInputs.simulationMode === 'contribution') {
                if (name === 'afterTaxMonthlyIncome' || name === 'monthlyInvestment') {
                     if (income > 0) {
                        const investment = Number(newInputs.monthlyInvestment) || 0;
                        newInputs.targetSavingsRate = Math.round(((investment / income) * 100) * 100) / 100;
                    } else { newInputs.targetSavingsRate = 0; }
                }
            }
            return newInputs;
        });
      }, []);

     const handleModeChange = useCallback((mode) => setInputs(prev => ({ ...prev, simulationMode: mode })), []);
     const handleGoalSettingModeChange = useCallback((mode) => setInputs(prev => ({ ...prev, goalSettingMode: mode })), []);
     const handleReset = useCallback(() => { localStorage.removeItem(STORAGE_KEY); setInputs(INITIAL_STATE); }, []);
     const handleAddEvent = useCallback(() => {
        setInputs(prev => {
            const sortedEvents = [...prev.lifeEvents].sort((a, b) => (Number(a.age) || Infinity) - (Number(b.age) || Infinity));
            const lastEvent = sortedEvents.length > 0 ? sortedEvents[sortedEvents.length - 1] : null;
            let lastIncome, lastInvestment;
            if (lastEvent) {
                lastIncome = Number(lastEvent.newMonthlyIncome) || Number(prev.afterTaxMonthlyIncome);
                lastInvestment = lastEvent.goalType === 'rate' ? (lastIncome * (Number(lastEvent.goalValue) || 0)) / 100 : Number(lastEvent.goalValue) || 0;
            } else {
                lastIncome = Number(prev.afterTaxMonthlyIncome);
                lastInvestment = prev.simulationMode === 'contribution' ? Number(prev.monthlyInvestment) : (lastIncome * (Number(prev.targetSavingsRate) || 0)) / 100;
            }
            const newEvent = { id: Date.now().toString(), age: (lastEvent ? Number(lastEvent.age) : Number(prev.currentAge)) + 5, newMonthlyIncome: lastIncome, goalType: 'amount', goalValue: Math.round(lastInvestment * 100) / 100 };
            return { ...prev, lifeEvents: [...prev.lifeEvents, newEvent] };
        });
      }, []);
      const handleDeleteEvent = useCallback((id) => setInputs(prev => ({ ...prev, lifeEvents: prev.lifeEvents.filter(event => event.id !== id) })), []);
      const handleEventChange = useCallback((id, field, value) => {
        setInputs(prev => {
           const sortedEvents = [...prev.lifeEvents].sort((a, b) => (Number(a.age) || Infinity) - (Number(b.age) || Infinity));
           let precedingIncome = Number(prev.afterTaxMonthlyIncome);
            for(const ev of sortedEvents) {
                if (ev.id === id) break;
                if(Number(ev.newMonthlyIncome) > 0) precedingIncome = Number(ev.newMonthlyIncome);
            }
           const updatedEvents = prev.lifeEvents.map(event => {
                if (event.id !== id) return event;
                let finalValue = value;
                if (field === 'age' || field === 'newMonthlyIncome' || field === 'goalValue') {
                    if (value === '') finalValue = '';
                    else {
                        const num = parseFloat(value);
                        if (!isNaN(num) && Number.isFinite(num)) finalValue = field === 'age' ? Math.round(num) : num;
                        else return event;
                    }
                }
                const updatedEvent = { ...event, [field]: finalValue };
                if(field === 'goalType') {
                    const incomeForConversion = Number(updatedEvent.newMonthlyIncome) > 0 ? Number(updatedEvent.newMonthlyIncome) : precedingIncome;
                    const currentGoalValue = Number(updatedEvent.goalValue) || 0;
                    if(value === 'rate' && incomeForConversion > 0) updatedEvent.goalValue = Math.round((currentGoalValue / incomeForConversion) * 100 * 100) / 100;
                    else if (value === 'amount') updatedEvent.goalValue = Math.round(((incomeForConversion * currentGoalValue) / 100) * 100) / 100;
                }
                return updatedEvent;
            });
            return { ...prev, lifeEvents: updatedEvents };
        });
      }, []);

      return (
        <div className="min-h-screen flex flex-col">
          <Header />
          <main className="flex-grow container mx-auto p-4 md:p-8">
            <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">
              <div className="lg:col-span-2">
                <InputForm inputs={inputs} onInputChange={handleInputChange} onReset={handleReset} onAddEvent={handleAddEvent} onDeleteEvent={handleDeleteEvent} onEventChange={handleEventChange} onModeChange={handleModeChange} onGoalSettingModeChange={handleGoalSettingModeChange} />
              </div>
              <div className="lg:col-span-3 space-y-8">
                <ResultsDisplay results={results} reverseResults={reverseResults} mode={inputs.simulationMode} />
                <AssetChart data={chartData} />
                <ShareModule results={results} chartData={chartData} />
                <HowToDeployFree />
              </div>
            </div>
          </main>
          <Footer />
        </div>
      );
    };

    // ====================================================================================
    //  Final Render Call
    // ====================================================================================
    
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>